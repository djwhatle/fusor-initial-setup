#!/bin/bash
: ${HOME:="/root"}
export HOME

: ${USER:="root"}
export USER

export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin

AUTOSTART_DIR="${HOME}/.config/autostart"
DESKTOP_DIR="${HOME}/Desktop"
WEBUI_SHORTCUT="${DESKTOP_DIR}/fusor_web_ui.desktop"
LOG_SHORTCUT="${DESKTOP_DIR}/fusor_install_log.desktop"
TERMINAL_AUTOSTART="{AUTOSTART_DIR}/fusor_installer.desktop"


DONE_FILE="/etc/.fusor-initial-setup.done"

if [ -e ${DONE_FILE} ] ; then
  echo "Path '${DONE_FILE}' exists"
  echo "Exitting as it looks like we already ran."
  exit 0
fi

#/usr/bin/rpm -qa --nosignature --nodigest --qf '%{NAME} %|EPOCH?{%{EPOCH}}:{0}| %{VERSION} %{RELEASE} %{ARCH}\n' &> /var/log/fusor_initial_setup
#echo "Ran rpm -qa command"

mkdir -p ${AUTOSTART_DIR}
cp /usr/share/applications/gnome-terminal.desktop ${TERMINAL_AUTOSTART}
chmod a+x ${TERMINAL_AUTOSTART}

sed -i ${WEBUI_SHORTCUT} -e 's/Exec=gnome-terminal/Exec=gnome-terminal /usr/bin/launch_fusor_installer'
sed -i ${WEBUI_SHORTCUT} -e 's/Name=Terminal/Name=Terminal to Launch Fusor Installer/'


mkdir -p ${DESKTOP_DIR}
cp /usr/share/applications/firefox.desktop ${WEBUI_SHORTCUT}
chmod a+x ${WEBUI_SHORTCUT}

cp /usr/share/applications/
cp /usr/share/applications/gedit.desktop ${LOG_SHORTCUT}
chmod a+x ${LOG_SHORTCUT}

chown -R ${USER} ${DESKTOP_DIR}

sed -i ${WEBUI_SHORTCUT} -e 's/Exec=firefox %u/Exec=firefox https:\/\/127.0.0.1/'
sed -i ${WEBUI_SHORTCUT} -e 's/Name=Firefox Web Browser/Name=Fusor WebUI/'

sed -i ${LOG_SHORTCUT} -e 's/Exec=gedit %U/Exec=gedit \/var\/log\/katello-installer\/katello-installer.log/'
sed -i ${LOG_SHORTCUT} -e 's/Name=gedit/Name=Fusor Installer Logs/'

touch ${DONE_FILE}
#/usr/sbin/katello-installer

#echo "Please press enter to continue with normal boot sequence"
#read dummy_value
