#!/bin/bash
: ${HOME:="/root"}
export HOME

: ${USER:="root"}
export USER

export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin

AUTOSTART_DIR="${HOME}/.config/autostart"
DESKTOP_DIR="${HOME}/Desktop"
WEBUI_SHORTCUT="${DESKTOP_DIR}/fusor_web_ui.desktop"
LOG_SHORTCUT="${DESKTOP_DIR}/fusor_install_log.desktop"
TERMINAL_AUTOSTART="${AUTOSTART_DIR}/fusor_installer.desktop"


DONE_FILE="/etc/.fusor-initial-setup.done"

if [ -e ${DONE_FILE} ] ; then
  echo "Path '${DONE_FILE}' exists"
  echo "Exitting as it looks like we already ran."
  exit 0
fi

#/usr/bin/rpm -qa --nosignature --nodigest --qf '%{NAME} %|EPOCH?{%{EPOCH}}:{0}| %{VERSION} %{RELEASE} %{ARCH}\n' &> /var/log/fusor_initial_setup
#echo "Ran rpm -qa command"

mkdir -p ${AUTOSTART_DIR}

cat > /usr/share/applications/fusor_installer.desktop << EOF
[Desktop Entry]
Type=Application
Encoding=UTF-8
Version=1.0
Name=Fusor Setup
Name[en_US]=Fusor Setup
Exec=/usr/bin/gnome-terminal -e "bash -c /usr/bin/launch-fusor-installer;bash"
X-GNOME-Autostart-enabled=true
X-GNOME-Autostart-Delay=1
EOF
chmod a+x /usr/share/applications/fusor_installer.desktop

#link setup in autostart
cp /usr/share/applications/fusor_installer.desktop ${AUTOSTART_DIR}/fusor_installer.desktop


mkdir -p ${DESKTOP_DIR}
cp /usr/share/applications/firefox.desktop ${WEBUI_SHORTCUT}
chmod a+x ${WEBUI_SHORTCUT}

cp /usr/share/applications/gedit.desktop ${LOG_SHORTCUT}
chmod a+x ${LOG_SHORTCUT}

chown -R ${USER} ${DESKTOP_DIR}

sed -i ${WEBUI_SHORTCUT} -e 's/Exec=firefox %u/Exec=firefox https:\/\/127.0.0.1/'
sed -i ${WEBUI_SHORTCUT} -e 's/Name=Firefox Web Browser/Name=Fusor WebUI/'

sed -i ${LOG_SHORTCUT} -e 's/Exec=gedit %U/Exec=gedit \/var\/log\/katello-installer\/katello-installer.log/'
sed -i ${LOG_SHORTCUT} -e 's/Name=gedit/Name=Fusor Installer Logs/'

touch ${DONE_FILE}
#/usr/sbin/katello-installer

#echo "Please press enter to continue with normal boot sequence"
#read dummy_value
